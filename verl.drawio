<mxfile host="Electron" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/29.3.6 Chrome/140.0.7339.249 Electron/38.8.0 Safari/537.36" version="29.3.6">
  <diagram name="第 1 页" id="1GiplrTgDFzIEkg3xYkR">
    <mxGraphModel dx="5333" dy="1682" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-1" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;line-height: 23px; color: rgb(248, 248, 242); background-color: rgb(39, 40, 34);&quot;&gt;&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;ActorRolloutRefWorker&lt;/span&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="40" width="130" x="220" y="410" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-2" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;line-height: 23px; color: rgb(248, 248, 242); background-color: rgb(39, 40, 34);&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;CriticWorker&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="40" width="70" x="220" y="470" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-4" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="实现actor、rollout、ref的工作流程" vertex="1">
          <mxGeometry height="30" width="190" x="30" y="415" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-5" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="实现价值计算的工作流程" vertex="1">
          <mxGeometry height="30" width="140" x="80" y="475" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-29" edge="1" parent="1" source="e5oy9tKHJuAL6xBgnzHY-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.25;entryY=0;entryDx=0;entryDy=0;" target="e5oy9tKHJuAL6xBgnzHY-26">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="435" y="1160" />
              <mxPoint x="760" y="1160" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-6" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;line-height: 23px; color: rgb(248, 248, 242); background-color: rgb(39, 40, 34);&quot;&gt;&lt;div style=&quot;&quot;&gt;role_worker_mapping &lt;span style=&quot;color: rgb(249, 38, 114);&quot;&gt;=&lt;/span&gt; {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;Role&lt;/span&gt;.ActorRollout: &lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;ray&lt;/span&gt;.&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;remote&lt;/span&gt;(&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;ActorRolloutRefWorker&lt;/span&gt;), &amp;nbsp;&lt;span style=&quot;color: rgb(136, 132, 111);&quot;&gt;# 注册为远程actor&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;Role&lt;/span&gt;.Critic: &lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;ray&lt;/span&gt;.&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;remote&lt;/span&gt;(&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;CriticWorker&lt;/span&gt;), &amp;nbsp;&lt;span style=&quot;color: rgb(136, 132, 111);&quot;&gt;# 注册为远程actor&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;Role&lt;/span&gt;.RefPolicy: &lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;ray&lt;/span&gt;.&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;remote&lt;/span&gt;(&lt;span style=&quot;color: rgb(166, 226, 46);&quot;&gt;ActorRolloutRefWorker&lt;/span&gt;) &amp;nbsp;&lt;span style=&quot;color: rgb(136, 132, 111);&quot;&gt;# 注册为远程actor&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="120" width="430" x="220" y="860" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-7" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="将角色和ray中的actor对应" vertex="1">
          <mxGeometry height="30" width="150" x="70" y="905" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-23" edge="1" parent="1" source="e5oy9tKHJuAL6xBgnzHY-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" target="e5oy9tKHJuAL6xBgnzHY-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-8" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;global_pool_id &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;global_pool&#39;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; resource_pool_spec &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; global_pool_id: [&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;config&lt;/span&gt;.trainer.n_gpus_per_node] &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;config&lt;/span&gt;.trainer.nnodes,&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="100" width="760" x="220" y="530" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-9" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="注册全局资源池：有几个节点，每个节点可以使用几张卡" vertex="1">
          <mxGeometry height="30" width="190" x="30" y="565" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-10" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;mapping &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.ActorRollout: global_pool_id, &lt;span style=&quot;color: #88846f;&quot;&gt;# Actor可以使用的资源池&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.Critic: global_pool_id, &lt;span style=&quot;color: #88846f;&quot;&gt;# Critic可以使用的资源池&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.RefPolicy: global_pool_id, &lt;span style=&quot;color: #88846f;&quot;&gt;# RefPolicy可以使用的资源池&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="120" width="630" x="220" y="650" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-11" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="将每个角色可以使用的资源池进行关联" vertex="1">
          <mxGeometry height="30" width="190" x="30" y="695" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-12" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;role_worker_mapping[&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.RewardModel] &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;ray&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;remote&lt;/span&gt;(&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;RewardModelWorker&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;mapping[&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.RewardModel] &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; global_pool_id&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="50" width="650" x="220" y="790" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-13" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="奖励模型配置" vertex="1">
          <mxGeometry height="30" width="80" x="140" y="800" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-17" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="根据键来获取资源池和根据角色来获取资源池" vertex="1">
          <mxGeometry height="30" width="130" x="1090" y="1050" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-19" parent="1" style="swimlane;fontStyle=0;childLayout=stackLayout;horizontal=1;startSize=30;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;whiteSpace=wrap;html=1;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;resource_pool_manager &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;ResourcePoolManager&lt;/span&gt;(resource_pool_spec&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;resource_pool_spec, mapping&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;mapping)&lt;/div&gt;" vertex="1">
          <mxGeometry height="610" width="1270" x="1090" y="430" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-20" parent="e5oy9tKHJuAL6xBgnzHY-19" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;spacingLeft=4;spacingRight=4;overflow=hidden;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;rotatable=0;whiteSpace=wrap;html=1;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;dataclass&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;class&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;ResourcePoolManager&lt;/span&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; Define a resource pool specification. Resource pool will be initialized first.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; Mapping&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; resource_pool_spec: &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;dict&lt;/span&gt;[&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;, &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;list&lt;/span&gt;[&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;int&lt;/span&gt;]]&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; mapping: &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;dict&lt;/span&gt;[&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;, &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;]&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; resource_pool_dict: &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;dict&lt;/span&gt;[&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;, &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;RayResourcePool&lt;/span&gt;] &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;field&lt;/span&gt;(&lt;span style=&quot;color: #a6e22e;&quot;&gt;default_factory&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;dict&lt;/span&gt;)&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;create_resource_pool&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; resource_pool_name, process_on_nodes &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.resource_pool_spec.&lt;span style=&quot;color: #a6e22e;&quot;&gt;items&lt;/span&gt;():&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# max_colocate_count means the number of WorkerGroups (i.e. processes) in each RayResourcePool&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# For FSDP backend, we recommend using max_colocate_count=1 that merge all WorkerGroups into one.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# For Megatron backend, we recommend using max_colocate_count&amp;gt;1 that can utilize different WorkerGroup for differnt models&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; resource_pool &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;RayResourcePool&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;process_on_nodes&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;process_on_nodes, &lt;span style=&quot;color: #88846f;&quot;&gt;# 定义每个节点上使用的GPU数量&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;use_gpu&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;True&lt;/span&gt;, &lt;span style=&quot;color: #88846f;&quot;&gt;# 是否使用GPU&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;max_colocate_count&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #ae81ff;&quot;&gt;1&lt;/span&gt;, &lt;span style=&quot;color: #88846f;&quot;&gt;# 定义每个资源池中可以同时放置的WorkerGroup数量&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;name_prefix&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;resource_pool_name) &lt;span style=&quot;color: #88846f;&quot;&gt;# 定义资源池的名称&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.resource_pool_dict[resource_pool_name] &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; resource_pool&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;get_resource_pool&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;role&lt;/span&gt;: &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;) -&amp;gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;RayResourcePool&lt;/span&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;Get the resource pool of the worker_cls&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.resource_pool_dict[&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.mapping[&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;role&lt;/span&gt;]]&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="580" width="1270" y="30" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-25" edge="1" parent="1" source="e5oy9tKHJuAL6xBgnzHY-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" target="e5oy9tKHJuAL6xBgnzHY-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-32" edge="1" parent="1" source="e5oy9tKHJuAL6xBgnzHY-26" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" target="e5oy9tKHJuAL6xBgnzHY-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-33" edge="1" parent="1" source="e5oy9tKHJuAL6xBgnzHY-26" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" target="e5oy9tKHJuAL6xBgnzHY-31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-26" parent="1" style="whiteSpace=wrap;html=1;align=left;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;trainer &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;RayPPOTrainer&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;config&lt;/span&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;tokenizer&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;tokenizer,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;role_worker_mapping&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;role_worker_mapping,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;resource_pool_manager&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;resource_pool_manager,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;ray_worker_group_cls&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;ray_worker_group_cls&lt;/span&gt;,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;reward_fn&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;reward_fn,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;val_reward_fn&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;val_reward_fn)&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="180" width="640" x="590" y="1220" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-27" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="初始化训练器，构建数据集" vertex="1">
          <mxGeometry height="30" width="153" x="827" y="1190" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-28" edge="1" parent="1" source="e5oy9tKHJuAL6xBgnzHY-26" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;entryX=0.624;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;startArrow=classicThin;startFill=1;endArrow=none;endFill=0;" target="e5oy9tKHJuAL6xBgnzHY-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-30" parent="1" style="swimlane;whiteSpace=wrap;html=1;" value="&lt;div style=&quot;color: #f8f8f2;background-color: #272822;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 17px;line-height: 23px;white-space: pre;&quot;&gt;trainer.&lt;span style=&quot;color: #a6e22e;&quot;&gt;init_workers&lt;/span&gt;()&lt;/div&gt;" vertex="1">
          <mxGeometry height="490" width="1095" x="-265" y="1480" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-2" edge="1" parent="e5oy9tKHJuAL6xBgnzHY-30" source="e5oy9tKHJuAL6xBgnzHY-34" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="TTrqs3erANF_UnLzMKeb-1" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-34" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;resource_pool &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.resource_pool_manager.&lt;span style=&quot;color: #a6e22e;&quot;&gt;get_resource_pool&lt;/span&gt;(&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.ActorRollout) &lt;span style=&quot;color: #88846f;&quot;&gt;# 获取ActorRollout可以使用的资源池&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# 包装ActorRollout类以及对应的初始化参数，用于创建WorkerGroup&lt;/span&gt;&lt;/div&gt;&lt;div&gt;actor_rollout_cls &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;RayClassWithInitArgs&lt;/span&gt;(&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;cls&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.role_worker_mapping[&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Role&lt;/span&gt;.ActorRollout],&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.config.actor_rollout_ref,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;role&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;actor_rollout&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #88846f;&quot;&gt;# 在资源池中添加ActorRollout类&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.resource_pool_to_cls[resource_pool][&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;actor_rollout&#39;&lt;/span&gt;] &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; actor_rollout_cls&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="160" width="1060" x="7.5" y="60" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-35" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="将每个角色放到自己对应的资源池中" vertex="1">
          <mxGeometry height="30" width="202.5" x="7.5" y="30" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-9" edge="1" parent="e5oy9tKHJuAL6xBgnzHY-30" source="TTrqs3erANF_UnLzMKeb-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="TTrqs3erANF_UnLzMKeb-8" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-1" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;worker_dict_cls &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;create_colocated_worker_cls&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;class_dict&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;class_dict)&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="40" width="642.5" x="216.25" y="300" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-3" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="它把多个不同角色的 Worker（如&amp;nbsp;actor_rollout、critic、ref）合并成一个&amp;nbsp;WorkerDict&amp;nbsp;类，使这些 Worker 在同一个 Ray Actor&amp;nbsp;进程中运行。并绑定不同角色的方法" vertex="1">
          <mxGeometry height="30" width="862.5" x="7.5" y="259" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-12" edge="1" parent="e5oy9tKHJuAL6xBgnzHY-30" source="TTrqs3erANF_UnLzMKeb-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="TTrqs3erANF_UnLzMKeb-11" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-8" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;wg_dict &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.ray_worker_group_cls(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;resource_pool&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;resource_pool, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;ray_cls_with_init&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;worker_dict_cls)&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="40" width="933.75" x="70.63" y="370" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-10" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="初始化一个raygroup组，并将 WorkerDict&amp;nbsp;类，在每个gpu上都存在，同时创建work" vertex="1">
          <mxGeometry height="20" width="445" x="7.5" y="350" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-11" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;spawn_wg &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; wg_dict.spawn(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;prefix_set&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;class_dict.&lt;span style=&quot;color: #a6e22e;&quot;&gt;keys&lt;/span&gt;())&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="40" width="509.38" x="282.81" y="440" as="geometry" />
        </mxCell>
        <mxCell id="TTrqs3erANF_UnLzMKeb-13" parent="e5oy9tKHJuAL6xBgnzHY-30" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="使用了上面创建的worker，并重新绑定了方法，上面只负责创建worker" vertex="1">
          <mxGeometry height="20" width="382.5" x="7.5" y="420" as="geometry" />
        </mxCell>
        <mxCell id="e5oy9tKHJuAL6xBgnzHY-31" parent="1" style="swimlane;whiteSpace=wrap;html=1;" value="&lt;div style=&quot;color: #f8f8f2;background-color: #272822;font-family: Consolas, &#39;Courier New&#39;, monospace;font-weight: normal;font-size: 17px;line-height: 23px;white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;trainer.&lt;span style=&quot;color: #a6e22e;&quot;&gt;fit&lt;/span&gt;()&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="200" width="240" x="1260" y="1480" as="geometry" />
        </mxCell>
        <mxCell id="zE-Qqkx6bLkerfbfMZxo-1" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="这里并没有真正创建actor，在&lt;span style=&quot;color: rgb(166, 226, 46); background-color: rgb(39, 40, 34);&quot;&gt;RayWorkerGroup.&lt;/span&gt;&lt;span style=&quot;background-color: rgb(39, 40, 34); color: rgb(166, 226, 46);&quot;&gt;_init_with_resource_pool，中创建&lt;/span&gt;" vertex="1">
          <mxGeometry height="30" width="300" x="660" y="905" as="geometry" />
        </mxCell>
        <mxCell id="yoynGbJFLcv7zVtcpmfj-3" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=#82b366;fillColor=#d5e8d4;align=left;verticalAlign=middle;rounded=0;" value="&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;target&#39;: 32,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;nums&#39;: array([41, 42, 58, 90]),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;data_source&#39;: &#39;countdown&#39;,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;prompt&#39;: array([{&#39;content&#39;: &#39;&amp;lt;|im_start|&amp;gt;system\nYou are a helpful assistant. You first thinks about the reasoning process in the mind and then provides the user with the &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;answer.&amp;lt;|im_end|&amp;gt;\n&amp;lt;|im_start|&amp;gt;user\n Using the numbers [41, 42, 58, 90], create an equation that equals 32. You can use basic arithmetic operations (+, -, *, /) and each &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;number can only be used once. Show your work in &amp;lt;think&amp;gt; &amp;lt;/think&amp;gt; tags. And return the final answer in &amp;lt;answer&amp;gt; &amp;lt;/answer&amp;gt; tags, for example &amp;lt;answer&amp;gt; (1 + 2) / 3 &lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&amp;lt;/answer&amp;gt;.&amp;lt;|im_end|&amp;gt;\n&amp;lt;|im_start|&amp;gt;assistant\nLet me solve this step by step.\n&amp;lt;think&amp;gt;&#39;, &#39;role&#39;: &#39;user&#39;}],&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;dtype=object),&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;ability&#39;: &#39;math&#39;,&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;reward_model&#39;: {&#39;ground_truth&#39;: {&#39;numbers&#39;: array([41, 42, 58, 90]), &#39;target&#39;: 32}, &#39;style&#39;: &#39;rule&#39;},&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&#39;extra_info&#39;: {&#39;index&#39;: 203761, &#39;split&#39;: &#39;train&#39;}&lt;/div&gt;&lt;div style=&quot;&quot;&gt;}&lt;/div&gt;" vertex="1">
          <mxGeometry height="270" width="940" x="1560" y="1230" as="geometry" />
        </mxCell>
        <mxCell id="yoynGbJFLcv7zVtcpmfj-4" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=#6c8ebf;fillColor=#dae8fc;align=left;verticalAlign=middle;rounded=0;" value="&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&#39;input_ids&#39;: tensor([[151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643, 151643,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;151643, 151643, 151643, 151643, 151643, 151643, 151643, 151644,&amp;nbsp; &amp;nbsp;8948,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 198,&amp;nbsp; &amp;nbsp;2610,&amp;nbsp; &amp;nbsp; 525,&amp;nbsp; &amp;nbsp; 264,&amp;nbsp; 10950,&amp;nbsp; 17847,&amp;nbsp; &amp;nbsp; &amp;nbsp;13,&amp;nbsp; &amp;nbsp;1446,&amp;nbsp; &amp;nbsp;1156,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 15482,&amp;nbsp; &amp;nbsp; 911,&amp;nbsp; &amp;nbsp; 279,&amp;nbsp; 32711,&amp;nbsp; &amp;nbsp;1882,&amp;nbsp; &amp;nbsp; 304,&amp;nbsp; &amp;nbsp; 279,&amp;nbsp; &amp;nbsp;3971,&amp;nbsp; &amp;nbsp; 323,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1221,&amp;nbsp; &amp;nbsp;5707,&amp;nbsp; &amp;nbsp; 279,&amp;nbsp; &amp;nbsp;1196,&amp;nbsp; &amp;nbsp; 448,&amp;nbsp; &amp;nbsp; 279,&amp;nbsp; &amp;nbsp;4226,&amp;nbsp; &amp;nbsp; &amp;nbsp;13, 151645,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 198, 151644,&amp;nbsp; &amp;nbsp; 872,&amp;nbsp; &amp;nbsp; 198,&amp;nbsp; 12091,&amp;nbsp; &amp;nbsp; 279,&amp;nbsp; &amp;nbsp;5109,&amp;nbsp; &amp;nbsp; 508,&amp;nbsp; &amp;nbsp; &amp;nbsp;19,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;16,&amp;nbsp; &amp;nbsp; &amp;nbsp;11,&amp;nbsp; &amp;nbsp; 220,&amp;nbsp; &amp;nbsp; &amp;nbsp;19,&amp;nbsp; &amp;nbsp; &amp;nbsp;17,&amp;nbsp; &amp;nbsp; &amp;nbsp;11,&amp;nbsp; &amp;nbsp; 220,&amp;nbsp; &amp;nbsp; &amp;nbsp;20,&amp;nbsp; &amp;nbsp; &amp;nbsp;23,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;11,&amp;nbsp; &amp;nbsp; 220,&amp;nbsp; &amp;nbsp; &amp;nbsp;24,&amp;nbsp; &amp;nbsp; &amp;nbsp;15,&amp;nbsp; &amp;nbsp;1125,&amp;nbsp; &amp;nbsp;1855,&amp;nbsp; &amp;nbsp; 458,&amp;nbsp; 23606,&amp;nbsp; &amp;nbsp; 429,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 16819,&amp;nbsp; &amp;nbsp; 220,&amp;nbsp; &amp;nbsp; &amp;nbsp;18,&amp;nbsp; &amp;nbsp; &amp;nbsp;17,&amp;nbsp; &amp;nbsp; &amp;nbsp;13,&amp;nbsp; &amp;nbsp;1446,&amp;nbsp; &amp;nbsp; 646,&amp;nbsp; &amp;nbsp; 990,&amp;nbsp; &amp;nbsp;6770,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 34784,&amp;nbsp; &amp;nbsp;7525,&amp;nbsp; 17973,&amp;nbsp; &amp;nbsp; &amp;nbsp;11,&amp;nbsp; 85922,&amp;nbsp; 11777,&amp;nbsp; &amp;nbsp; 608,&amp;nbsp; &amp;nbsp; &amp;nbsp; 8,&amp;nbsp; &amp;nbsp; 323,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1817,&amp;nbsp; &amp;nbsp;1372,&amp;nbsp; &amp;nbsp; 646,&amp;nbsp; &amp;nbsp;1172,&amp;nbsp; &amp;nbsp; 387,&amp;nbsp; &amp;nbsp;1483,&amp;nbsp; &amp;nbsp;3055,&amp;nbsp; &amp;nbsp; &amp;nbsp;13,&amp;nbsp; &amp;nbsp;6928,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 697,&amp;nbsp; &amp;nbsp; 975,&amp;nbsp; &amp;nbsp; 304,&amp;nbsp; &amp;nbsp; 366,&amp;nbsp; 26865,&amp;nbsp; &amp;nbsp; &amp;nbsp;29,&amp;nbsp; &amp;nbsp; 690,&amp;nbsp; 26865,&amp;nbsp; &amp;nbsp; &amp;nbsp;29,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;9492,&amp;nbsp; &amp;nbsp; &amp;nbsp;13,&amp;nbsp; &amp;nbsp;1597,&amp;nbsp; &amp;nbsp; 470,&amp;nbsp; &amp;nbsp; 279,&amp;nbsp; &amp;nbsp;1590,&amp;nbsp; &amp;nbsp;4226,&amp;nbsp; &amp;nbsp; 304,&amp;nbsp; &amp;nbsp; 366,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;9217,&amp;nbsp; &amp;nbsp; &amp;nbsp;29,&amp;nbsp; &amp;nbsp; 690,&amp;nbsp; &amp;nbsp;9217,&amp;nbsp; &amp;nbsp; &amp;nbsp;29,&amp;nbsp; &amp;nbsp;9492,&amp;nbsp; &amp;nbsp; &amp;nbsp;11,&amp;nbsp; &amp;nbsp; 369,&amp;nbsp; &amp;nbsp;3110,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 366,&amp;nbsp; &amp;nbsp;9217,&amp;nbsp; &amp;nbsp; &amp;nbsp;29,&amp;nbsp; &amp;nbsp; 320,&amp;nbsp; &amp;nbsp; &amp;nbsp;16,&amp;nbsp; &amp;nbsp; 488,&amp;nbsp; &amp;nbsp; 220,&amp;nbsp; &amp;nbsp; &amp;nbsp;17,&amp;nbsp; &amp;nbsp; &amp;nbsp; 8,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 608,&amp;nbsp; &amp;nbsp; 220,&amp;nbsp; &amp;nbsp; &amp;nbsp;18,&amp;nbsp; &amp;nbsp; 690,&amp;nbsp; &amp;nbsp;9217,&amp;nbsp; 14276, 151645,&amp;nbsp; &amp;nbsp; 198, 151644,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 77091,&amp;nbsp; &amp;nbsp; 198,&amp;nbsp; 10061,&amp;nbsp; &amp;nbsp; 752,&amp;nbsp; 11625,&amp;nbsp; &amp;nbsp; 419,&amp;nbsp; &amp;nbsp;3019,&amp;nbsp; &amp;nbsp; 553,&amp;nbsp; &amp;nbsp;3019,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 624,&amp;nbsp; 13708,&amp;nbsp; &amp;nbsp; 766,&amp;nbsp; &amp;nbsp; &amp;nbsp;29]]),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;attention_mask&#39;: tensor([[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]]),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;position_ids&#39;: tensor([[&amp;nbsp; 0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;0,&amp;nbsp; &amp;nbsp;1,&amp;nbsp; &amp;nbsp;2,&amp;nbsp; &amp;nbsp;3,&amp;nbsp; &amp;nbsp;4,&amp;nbsp; &amp;nbsp;5,&amp;nbsp; &amp;nbsp;6,&amp;nbsp; &amp;nbsp;7,&amp;nbsp; &amp;nbsp;8,&amp;nbsp; &amp;nbsp;9,&amp;nbsp; 10,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 11,&amp;nbsp; 12,&amp;nbsp; 13,&amp;nbsp; 14,&amp;nbsp; 15,&amp;nbsp; 16,&amp;nbsp; 17,&amp;nbsp; 18,&amp;nbsp; 19,&amp;nbsp; 20,&amp;nbsp; 21,&amp;nbsp; 22,&amp;nbsp; 23,&amp;nbsp; 24,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 25,&amp;nbsp; 26,&amp;nbsp; 27,&amp;nbsp; 28,&amp;nbsp; 29,&amp;nbsp; 30,&amp;nbsp; 31,&amp;nbsp; 32,&amp;nbsp; 33,&amp;nbsp; 34,&amp;nbsp; 35,&amp;nbsp; 36,&amp;nbsp; 37,&amp;nbsp; 38,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 39,&amp;nbsp; 40,&amp;nbsp; 41,&amp;nbsp; 42,&amp;nbsp; 43,&amp;nbsp; 44,&amp;nbsp; 45,&amp;nbsp; 46,&amp;nbsp; 47,&amp;nbsp; 48,&amp;nbsp; 49,&amp;nbsp; 50,&amp;nbsp; 51,&amp;nbsp; 52,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 53,&amp;nbsp; 54,&amp;nbsp; 55,&amp;nbsp; 56,&amp;nbsp; 57,&amp;nbsp; 58,&amp;nbsp; 59,&amp;nbsp; 60,&amp;nbsp; 61,&amp;nbsp; 62,&amp;nbsp; 63,&amp;nbsp; 64,&amp;nbsp; 65,&amp;nbsp; 66,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 67,&amp;nbsp; 68,&amp;nbsp; 69,&amp;nbsp; 70,&amp;nbsp; 71,&amp;nbsp; 72,&amp;nbsp; 73,&amp;nbsp; 74,&amp;nbsp; 75,&amp;nbsp; 76,&amp;nbsp; 77,&amp;nbsp; 78,&amp;nbsp; 79,&amp;nbsp; 80,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 81,&amp;nbsp; 82,&amp;nbsp; 83,&amp;nbsp; 84,&amp;nbsp; 85,&amp;nbsp; 86,&amp;nbsp; 87,&amp;nbsp; 88,&amp;nbsp; 89,&amp;nbsp; 90,&amp;nbsp; 91,&amp;nbsp; 92,&amp;nbsp; 93,&amp;nbsp; 94,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 95,&amp;nbsp; 96,&amp;nbsp; 97,&amp;nbsp; 98,&amp;nbsp; 99, 100, 101, 102, 103, 104, 105, 106, 107, 108,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;137, 138, 139, 140]]), &#39;target&#39;: array([32], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;nums&#39;: array([[41, 42, 58, 90]], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;data_source&#39;: array([&#39;countdown&#39;], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;ability&#39;: array([&#39;math&#39;], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;reward_model&#39;: array([{&#39;ground_truth&#39;: {&#39;numbers&#39;: array([41, 42, 58, 90]), &#39;target&#39;: 32}, &#39;style&#39;: &#39;rule&#39;}], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;extra_info&#39;: array([{&#39;index&#39;: 203761, &#39;split&#39;: &#39;train&#39;}], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;index&#39;: array([203761], dtype=object)}&lt;/div&gt;" vertex="1">
          <mxGeometry height="970" width="640" x="1560" y="1540" as="geometry" />
        </mxCell>
        <mxCell id="yoynGbJFLcv7zVtcpmfj-5" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=#d79b00;fillColor=#ffe6cc;align=left;verticalAlign=middle;rounded=0;" value="&lt;div&gt;DataProto(batch=&lt;/div&gt;&lt;div&gt;TensorDict(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; fields={&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; attention_mask: Tensor(shape=torch.Size([1, 256]), device=cpu, dtype=torch.int64, is_shared=False),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; input_ids: Tensor(shape=torch.Size([1, 256]), device=cpu, dtype=torch.int64, is_shared=False),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; position_ids: Tensor(shape=torch.Size([1, 256]), device=cpu, dtype=torch.int64, is_shared=False)},&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; batch_size=torch.Size([1]),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; device=None,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; is_shared=False),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;non_tensor_batch={&#39;target&#39;: array([32], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;nums&#39;: array([[41, 42, 58, 90]], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;data_source&#39;: array([&#39;countdown&#39;], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;ability&#39;: array([&#39;math&#39;], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;reward_model&#39;: array([{&#39;ground_truth&#39;: {&#39;numbers&#39;: array([41, 42, 58, 90]), &#39;target&#39;: 32}, &#39;style&#39;: &#39;rule&#39;}], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div&gt;&#39;extra_info&#39;: array([{&#39;index&#39;: 203761, &#39;split&#39;: &#39;train&#39;}], dtype=object),&amp;nbsp;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&#39;index&#39;: array([203761], dtype=object)}, meta_info={})&lt;/div&gt;" vertex="1">
          <mxGeometry height="260" width="640" x="2240" y="1540" as="geometry" />
        </mxCell>
        <mxCell id="yoynGbJFLcv7zVtcpmfj-6" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=#b85450;fillColor=#f8cecc;align=left;verticalAlign=middle;rounded=0;" value="&lt;div&gt;DataProto(batch=TensorDict(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; fields={&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; attention_mask: Tensor(shape=torch.Size([1, 256]), device=cpu, dtype=torch.int64, is_shared=False),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; input_ids: Tensor(shape=torch.Size([1, 256]), device=cpu, dtype=torch.int64, is_shared=False),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; position_ids: Tensor(shape=torch.Size([1, 256]), device=cpu, dtype=torch.int64, is_shared=False)},&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; batch_size=torch.Size([1]),&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; device=None,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; is_shared=False), non_tensor_batch={}, meta_info={})&lt;/div&gt;" vertex="1">
          <mxGeometry height="150" width="560" x="2240" y="1830" as="geometry" />
        </mxCell>
        <mxCell id="yoynGbJFLcv7zVtcpmfj-7" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=#9673a6;fillColor=#e1d5e7;align=left;verticalAlign=middle;rounded=0;" value="&lt;div&gt;# 混合并行：FSDP + vLLM TP 数据流对比&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;## 1. 传统数据并行 (DP)&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;每个 rank：完整模型 + 不同数据分片&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Rank 0: [Model] + [batch 0,1,2,3]&amp;nbsp; &amp;nbsp;→ 独立前向/反向&lt;/div&gt;&lt;div&gt;Rank 1: [Model] + [batch 4,5,6,7]&amp;nbsp; &amp;nbsp;→ 独立前向/反向&lt;/div&gt;&lt;div&gt;Rank 2: [Model] + [batch 8,9,...]&amp;nbsp; &amp;nbsp;→ 独立前向/反向&lt;/div&gt;&lt;div&gt;...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;最后：AllReduce 梯度,各 rank 数据互不共享&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;**特点:** 每个 rank 有完整模型、不同 batch，各自算自己的数据，只在梯度上做 AllReduce。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;## 2. vLLM 张量并行 (TP)&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;每个 TP rank：模型的一部分 + 同一份完整数据&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;TP 组内 rank 0: [Model 前半] + [batch 0,1,2,3]&amp;nbsp; ┐&lt;/div&gt;&lt;div&gt;TP 组内 rank 1: [Model 后半] + [batch 0,1,2,3]&amp;nbsp; ├─ 协同计算&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;两个 rank 必须处理同一批数据,因为计算被切分到不同 rank&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;**特点:** TP 组内每个 rank 只持有一部分模型，但必须共享同一份完整 batch，一起完成一次前向。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;## 3. 差异对比&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;| 维度 | 传统 DP | vLLM TP |&lt;/div&gt;&lt;div&gt;|------|---------|---------|&lt;/div&gt;&lt;div&gt;| **模型** | 每 rank 完整模型 | 每 rank 模型分片 |&lt;/div&gt;&lt;div&gt;| **数据** | 每 rank 不同 batch | TP 组内同一 batch |&lt;/div&gt;&lt;div&gt;| **计算** | 各 rank 独立前向 | TP 组内协同前向 |&lt;/div&gt;&lt;div&gt;| **通信** | 梯度 AllReduce | 激活/中间结果在 TP 组内通信 |&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;## 4. verl 里的混合模式&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;### 训练阶段 (FSDP)&lt;/div&gt;&lt;div&gt;- **模型:** 按 FSDP 分片到各 rank&lt;/div&gt;&lt;div&gt;- **数据:** 按 DP 分片，每个 rank 不同 batch&lt;/div&gt;&lt;div&gt;- **流程:** allgather 参数 → 前向 → 释放参数 → scatter 梯度&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;### 推理阶段 (vLLM TP)&lt;/div&gt;&lt;div&gt;- **模型:** 按 TP 分片，每个 TP 组共享一份完整模型&lt;/div&gt;&lt;div&gt;- **数据:** TP 组内必须共享同一份完整 batch&lt;/div&gt;&lt;div&gt;- **关键:** 需要 `preprocess_data` 把 DP 分片 allgather 成 TP 组内完整数据&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;## 5. 为什么需要 preprocess_data&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;FSDP 视角（按 DP 分片）:&lt;/div&gt;&lt;div&gt;&amp;nbsp; rank 0: [batch 0,1]&amp;nbsp; &amp;nbsp; rank 1: [batch 2,3]&lt;/div&gt;&lt;div&gt;&amp;nbsp; rank 2: [batch 4,5]&amp;nbsp; &amp;nbsp; rank 3: [batch 6,7]&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;↓&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;↓&lt;/div&gt;&lt;div&gt;&amp;nbsp; preprocess_data：在 TP 组内 allgather&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;↓&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;↓&lt;/div&gt;&lt;div&gt;vLLM TP 视角（TP 组内共享完整 batch）:&lt;/div&gt;&lt;div&gt;&amp;nbsp; rank 0,1: [batch 0,1,2,3]&lt;/div&gt;&lt;div&gt;&amp;nbsp; rank 2,3: [batch 4,5,6,7]&lt;/div&gt;&lt;div&gt;```&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;## 核心区别&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;- **传统 DP:** 「各算各的，最后同步梯度」&lt;/div&gt;&lt;div&gt;- **vLLM TP:** 「同一 TP 组内必须算同一批数据」&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;因此需要 `preprocess_data` 把 DP 分片转成 TP 组内共享的完整 batch，这是与传统 DP 的本质区别。&lt;/div&gt;" vertex="1">
          <mxGeometry height="1150" width="560" x="2240" y="2010" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-3" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="JccxReVzyzG5V8PLj5EJ-2" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-5" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="JccxReVzyzG5V8PLj5EJ-4" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-1" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_wg.init_model()&lt;/div&gt;" vertex="1">
          <mxGeometry height="30" width="280" x="-1300" y="2320" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-9" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;" target="JccxReVzyzG5V8PLj5EJ-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-11" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="JccxReVzyzG5V8PLj5EJ-10" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-13" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=1;exitDx=0;exitDy=0;" target="JccxReVzyzG5V8PLj5EJ-12">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-962" y="2670" />
              <mxPoint x="-710" y="2670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-2" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;func_generator&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;dispatch_fn&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;collect_fn&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;execute_fn&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;blocking&lt;/span&gt;):&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;func&lt;/span&gt;(&lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt; &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;dispatch_fn&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; output &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;execute_fn&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;blocking&lt;/span&gt;:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; output &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;ray&lt;/span&gt;.get(output)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; output &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;collect_fn&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;, output)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; output&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;func&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="260" width="790" x="-1555" y="2370" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-4" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;@&lt;/span&gt;&lt;span style=&quot;color: #a6e22e;&quot;&gt;register&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;dispatch_mode&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Dispatch&lt;/span&gt;.ONE_TO_ALL)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;init_model&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# This is used to import external_lib into the huggingface systems&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #a6e22e;&quot;&gt;import_external_libs&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.config.model.get(&lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;external_lib&#39;&lt;/span&gt;, &lt;span style=&quot;color: #ae81ff;&quot;&gt;None&lt;/span&gt;))&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;from&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;verl&lt;/span&gt;.&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;workers&lt;/span&gt;.&lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;critic&lt;/span&gt; &lt;span style=&quot;color: #f92672;&quot;&gt;import&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;DataParallelPPOCritic&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_module, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_optimizer, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_lr_scheduler &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;_build_critic_model_optimizer&lt;/span&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.config)&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;._is_offload_param:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #a6e22e;&quot;&gt;offload_fsdp_param_and_grad&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;module&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_module, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;offload_grad&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;._is_offload_grad)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;._is_offload_optimizer:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #a6e22e;&quot;&gt;offload_fsdp_optimizer&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;optimizer&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_optimizer)&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;DataParallelPPOCritic&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;config&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.config,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;critic_module&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_module,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;critic_optimizer&lt;/span&gt;&lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_optimizer)&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.flops_counter &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;FlopsCounter&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.critic_model_config)&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;torch&lt;/span&gt;.cuda.empty_cache()&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="490" width="1060" x="-740" y="2090" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-7" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;dispatch_one_to_all&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;worker_group&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt; &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;tuple&lt;/span&gt;([arg] &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;worker_group&lt;/span&gt;.world_size &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; arg &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt; &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; {k: [v] &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;worker_group&lt;/span&gt;.world_size &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; k, v &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;items&lt;/span&gt;()}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="90" width="700" x="-2130" y="2690" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-10" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;collect_all_to_all&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;worker_group&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;output&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;output&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="60" width="425" x="-1372.5" y="2690" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-15" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-12" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="JccxReVzyzG5V8PLj5EJ-14" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-12" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;get_predefined_execute_fn&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;execute_mode&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #e6db74;&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; Note that here we only asks execute_all and execute_rank_zero to be implemented&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; Leave the choice of how these two functions handle argument &#39;blocking&#39; to users&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;color: #e6db74;&quot;&gt;&amp;nbsp; &amp;nbsp; &quot;&quot;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; predefined_execute_mode_fn &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Execute&lt;/span&gt;.ALL: {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;execute_fn_name&#39;&lt;/span&gt;: &lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;execute_all&#39;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; },&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: rgb(166, 226, 46); text-decoration-line: underline;&quot;&gt;Execute&lt;/span&gt;.RANK_ZERO: {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;execute_fn_name&#39;&lt;/span&gt;: &lt;span style=&quot;color: #e6db74;&quot;&gt;&#39;execute_rank_zero&#39;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; predefined_execute_mode_fn[&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;execute_mode&lt;/span&gt;]&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="330" width="780" x="-1100" y="2800" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-17" edge="1" parent="1" source="JccxReVzyzG5V8PLj5EJ-14" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" target="JccxReVzyzG5V8PLj5EJ-16" value="">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-14" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;execute_all&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;: &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;execute_all_async&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;)&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="50" width="630" x="-1025" y="3190" as="geometry" />
        </mxCell>
        <mxCell id="JccxReVzyzG5V8PLj5EJ-16" parent="1" style="text;html=1;whiteSpace=wrap;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;" value="&lt;div style=&quot;color: rgb(248, 248, 242); background-color: rgb(39, 40, 34); font-family: Consolas, &amp;quot;Courier New&amp;quot;, monospace; font-size: 17px; line-height: 23px; white-space: pre;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div style=&quot;line-height: 23px;&quot;&gt;&lt;div&gt;&lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color: #a6e22e;&quot;&gt;execute_all_async&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;: &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;str&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# 这里我们假设，如果 args 和 kwargs 里面所有的参数都是 list，且所有的 list 长度都与 len(self._workers) 一致的话，我们会把&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# list 中的每一个分别发到对应的 worker 上去&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# print(f&quot;execute_all_async: method {method_name}({args}, {kwargs})&quot;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; length &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;&quot;&gt;len&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;._workers)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;&quot;&gt;all&lt;/span&gt;(&lt;span style=&quot;color: #66d9ef;&quot;&gt;isinstance&lt;/span&gt;(arg, &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;list&lt;/span&gt;) &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; arg &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;) &lt;span style=&quot;color: #f92672;&quot;&gt;and&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;&quot;&gt;all&lt;/span&gt;(&lt;span style=&quot;color: #66d9ef;&quot;&gt;isinstance&lt;/span&gt;(kwarg, &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;list&lt;/span&gt;) &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; kwarg &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;values&lt;/span&gt;()):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;&quot;&gt;all&lt;/span&gt;(&lt;span style=&quot;color: #66d9ef;&quot;&gt;len&lt;/span&gt;(arg) &lt;span style=&quot;color: #f92672;&quot;&gt;==&lt;/span&gt; length &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; arg &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;) &lt;span style=&quot;color: #f92672;&quot;&gt;and&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;&quot;&gt;all&lt;/span&gt;(&lt;span style=&quot;color: #66d9ef;&quot;&gt;len&lt;/span&gt;(kwarg) &lt;span style=&quot;color: #f92672;&quot;&gt;==&lt;/span&gt; length &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; kwarg &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;values&lt;/span&gt;()):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #88846f;&quot;&gt;# print(f&quot;splitting args and kwargs into {length} shards&quot;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; []&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; i &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;range&lt;/span&gt;(length):&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sliced_args &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;font-style: italic;&quot;&gt;tuple&lt;/span&gt;(arg[i] &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; arg &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; sliced_kwargs &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; {k: v[i] &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; k, v &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;.&lt;span style=&quot;color: #a6e22e;&quot;&gt;items&lt;/span&gt;()}&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; remote_call &lt;span style=&quot;color: #f92672;&quot;&gt;=&lt;/span&gt; &lt;span style=&quot;color: #66d9ef;&quot;&gt;getattr&lt;/span&gt;(&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;._workers[i], &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; result.&lt;span style=&quot;color: #a6e22e;&quot;&gt;append&lt;/span&gt;(remote_call.remote(&lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;sliced_args, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;sliced_kwargs))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; result&lt;/div&gt;&lt;br&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;span style=&quot;color: #f92672;&quot;&gt;return&lt;/span&gt; [&lt;span style=&quot;color: #66d9ef;&quot;&gt;getattr&lt;/span&gt;(worker, &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;method_name&lt;/span&gt;).remote(&lt;span style=&quot;color: #f92672;&quot;&gt;*&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;args&lt;/span&gt;, &lt;span style=&quot;color: #f92672;&quot;&gt;**&lt;/span&gt;&lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;kwargs&lt;/span&gt;) &lt;span style=&quot;color: #f92672;&quot;&gt;for&lt;/span&gt; worker &lt;span style=&quot;color: #f92672;&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color: #fd971f;font-style: italic;&quot;&gt;self&lt;/span&gt;._workers]&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" vertex="1">
          <mxGeometry height="390" width="1180" x="-1300" y="3310" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
